

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tank.util.filesystem &mdash; tk-core v0.22.6 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    <a href='https://help.autodesk.com/view/SGDEV/ENU/'>
    
        <img style='width: 191px;
                height: 60px;
                margin: 2px;
                border-radius: 0px;
                padding: 0px;'
            src='../../../_static/logo@2x.png'/>
    
    </a>
    

          
          
          <a href="../../../index.html" class="icon icon-home">
            tk-core
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../initializing.html">Initialization and startup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core.html">Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../platform.html">Apps, Engines and Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../descriptor.html">Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../environment_variables.html">Environment Variables</a></li>
</ul>


    <a href='genindex.html'>Alphabetic Index</a>

    <div style='margin-top: 50px;
                margin-left: 10px;
                margin-right: 10px;
                padding: 10px;
                color: #b3b3b3;
                font-size: 70%;
                border-radius: 3px;
                background-color: #444;
                line-height: 18px;
                '>
    <style>
        a.custom_post_menu { display: inline;
                             padding: 0px;
                             text-decoration: underline; }
    </style>

    <b>tk-core</b> v0.22.6.<br>
    
        This documentation is part of the Flow Production Tracking.
    
    For more information, please visit
    <a class=custom_post_menu href='https://help.autodesk.com/view/SGDEV/ENU/'>The Flow Production Tracking developer portal.</a>.
    The code associated with this documentation can be found
    <a class=custom_post_menu href='https://github.com/shotgunsoftware/tk-core'>here</a>.

    </div>
    <style>
        p.privacy_links { margin: 4px 0px;}
    </style>
    <p class="privacy_links"><a data-opt-in-preferences href="javascript:;">Privacy settings</a></p>
    <p class="privacy_links"><a data-wat-linkname="manage-ccpa-settings-footer-link" href="javascript:;">Do not sell my personal information</a></p>
    <p class="privacy_links"><a href="https://www.autodesk.com/company/legal-notices-trademarks/privacy-statement">Privacy/Cookies</a></p>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">tk-core</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tank.util.filesystem</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tank.util.filesystem</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2016 Shotgun Software Inc.</span>
<span class="c1"># CONFIDENTIAL AND PROPRIETARY</span>
<span class="c1">#</span>
<span class="c1"># This work is provided &quot;AS IS&quot; and subject to the Shotgun Pipeline Toolkit</span>
<span class="c1"># Source Code License included in this distribution package. See LICENSE.</span>
<span class="c1"># By accessing, using, copying or modifying this work you indicate your</span>
<span class="c1"># agreement to the Shotgun Pipeline Toolkit Source Code License. All rights</span>
<span class="c1"># not expressly granted therein are reserved by Shotgun Software Inc.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utility methods for manipulating files and folders</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">stat</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.platforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_linux</span><span class="p">,</span> <span class="n">is_macos</span><span class="p">,</span> <span class="n">is_windows</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># files or directories to skip if no skip_list is specified</span>
<span class="n">SKIP_LIST_DEFAULT</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.svn&quot;</span><span class="p">,</span> <span class="s2">&quot;.git&quot;</span><span class="p">,</span> <span class="s2">&quot;.gitignore&quot;</span><span class="p">,</span> <span class="s2">&quot;.hg&quot;</span><span class="p">,</span> <span class="s2">&quot;.hgignore&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="with_cleared_umask"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.with_cleared_umask">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">with_cleared_umask</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator which clears the umask for a method.</span>

<span class="sd">    The umask is a permissions mask that gets applied</span>
<span class="sd">    whenever new files or folders are created. For I/O methods</span>
<span class="sd">    that have a permissions parameter, it is important that the</span>
<span class="sd">    umask is cleared prior to execution, otherwise the default</span>
<span class="sd">    umask may alter the resulting permissions, for example::</span>

<span class="sd">        def create_folders(path, permissions=0777):</span>
<span class="sd">            log.debug(&quot;Creating folder %s...&quot; % path)</span>
<span class="sd">            os.makedirs(path, permissions)</span>

<span class="sd">    The 0777 permissions indicate that we want folders to be</span>
<span class="sd">    completely open for all users (a+rwx). However, the umask</span>
<span class="sd">    overrides this, so if the umask for example is set to 0777,</span>
<span class="sd">    meaning that I/O operations are not allowed to create files</span>
<span class="sd">    that are readable, executable or writable for users, groups</span>
<span class="sd">    or others, the resulting permissions on folders created</span>
<span class="sd">    by create folders will be 0, despite passing in 0777 permissions.</span>

<span class="sd">    By adding this decorator to the method, we temporarily reset</span>
<span class="sd">    the umask to 0, thereby giving full control to</span>
<span class="sd">    any permissions operation to take place without any restriction</span>
<span class="sd">    by the umask::</span>

<span class="sd">        @with_cleared_umask</span>
<span class="sd">        def create_folders(path, permissions=0777):</span>
<span class="sd">            # Creates folders with the given permissions,</span>
<span class="sd">            # regardless of umask setting.</span>
<span class="sd">            log.debug(&quot;Creating folder %s...&quot; % path)</span>
<span class="sd">            os.makedirs(path, permissions)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># set umask to zero, store old umask</span>
        <span class="n">old_umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># execute method payload</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># set mask back to previous value</span>
            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">old_umask</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="compute_folder_size"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.compute_folder_size">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">compute_folder_size</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes and returns the size of the given folder.</span>

<span class="sd">    :param path: folder to compute size for</span>
<span class="sd">    :return: size in bytes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">total_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total_size</span></div>


<div class="viewcode-block" id="touch_file"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.touch_file">[docs]</a><span class="nd">@with_cleared_umask</span>
<span class="k">def</span><span class="w"> </span><span class="nf">touch_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="mo">0o666</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Touch a file and optionally set its permissions.</span>

<span class="sd">    :param path: path to touch</span>
<span class="sd">    :param permissions: Optional permissions to set on the file. Default value is 0666,</span>
<span class="sd">                        creating a file that is readable and writable for all users.</span>

<span class="sd">    :raises: OSError - if there was a problem reading/writing the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Race conditions are perfectly possible on some network storage</span>
            <span class="c1"># setups so make sure that we ignore any file already exists errors,</span>
            <span class="c1"># as they are not really errors!</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="ensure_folder_exists"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.ensure_folder_exists">[docs]</a><span class="nd">@with_cleared_umask</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_folder_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="mo">0o775</span><span class="p">,</span> <span class="n">create_placeholder_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method - creates a folder and parent folders if such do not already exist.</span>

<span class="sd">    :param path: path to create</span>
<span class="sd">    :param permissions: Permissions to use when folder is created</span>
<span class="sd">    :param create_placeholder_file: If true, a placeholder file will be generated.</span>

<span class="sd">    :raises: OSError - if there was a problem creating the folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">create_placeholder_file</span><span class="p">:</span>
                <span class="n">ph_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ph_path</span><span class="p">):</span>
                    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ph_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;This file was automatically generated by Flow Production Tracking.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;The placeholder file is needed when managing toolkit configurations</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;in source control packages such as git and perforce. These systems</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;do not handle empty folders so a placeholder file is required for the </span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;folder to be tracked and managed properly.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Race conditions are perfectly possible on some network storage setups</span>
            <span class="c1"># so make sure that we ignore any file already exists errors, as they</span>
            <span class="c1"># are not really errors!</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                <span class="c1"># re-raise</span>
                <span class="k">raise</span></div>


<div class="viewcode-block" id="copy_file"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.copy_file">[docs]</a><span class="nd">@with_cleared_umask</span>
<span class="k">def</span><span class="w"> </span><span class="nf">copy_file</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="mo">0o666</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy file and sets its permissions.</span>

<span class="sd">    :param src: Source file</span>
<span class="sd">    :param dst: Target destination</span>
<span class="sd">    :param permissions: Permissions to use for target file. Default permissions will</span>
<span class="sd">                        be readable and writable for all users.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_windows</span><span class="p">():</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="c1"># Check if the dst is a directory and change it to a filename if it is</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>

        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
        <span class="c1"># Use larger copy buffer in the shutil.copyfileobj operation</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">windows_src</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">windows_dst</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">windows_src</span><span class="p">,</span> <span class="n">windows_dst</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Used shutil override on Windows&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">permissions</span><span class="p">)</span></div>


<div class="viewcode-block" id="safe_delete_file"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.safe_delete_file">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">safe_delete_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the given file if it exists.</span>

<span class="sd">    Ignores any errors raised in the process and logs them as warnings.</span>
<span class="sd">    If the user does not have sufficient permissions to</span>
<span class="sd">    remove the file, nothing will happen, it will simply</span>
<span class="sd">    be skipped over.</span>

<span class="sd">    :param path: Full path to file to remove</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="c1"># on windows, make sure file is not read-only</span>
            <span class="k">if</span> <span class="n">is_windows</span><span class="p">():</span>
                <span class="c1"># make sure we have write permission</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;File &#39;</span><span class="si">%s</span><span class="s2">&#39; could not be deleted, skipping: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="copy_folder"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.copy_folder">[docs]</a><span class="nd">@with_cleared_umask</span>
<span class="k">def</span><span class="w"> </span><span class="nf">copy_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">folder_permissions</span><span class="o">=</span><span class="mo">0o775</span><span class="p">,</span> <span class="n">skip_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Alternative implementation to ``shutil.copytree``</span>

<span class="sd">    Copies recursively and creates folders if they don&#39;t already exist.</span>
<span class="sd">    Always skips system files such as ``&quot;__MACOSX&quot;``, ``&quot;.DS_Store&quot;``, etc.</span>
<span class="sd">    Files will the extension ``.sh``, ``.bat`` or ``.exe`` will be given</span>
<span class="sd">    executable permissions.</span>

<span class="sd">    Returns a list of files that were copied.</span>

<span class="sd">    :param src: Source path to copy from</span>
<span class="sd">    :param dst: Destination to copy to</span>
<span class="sd">    :param folder_permissions: permissions to use for new folders</span>
<span class="sd">    :param skip_list: List of file names to skip. If this parameter is</span>
<span class="sd">                      omitted or set to None, common files such as ``.git``,</span>
<span class="sd">                      ``.gitignore`` etc will be ignored.</span>
<span class="sd">    :returns: List of files copied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># files or directories to always skip</span>
    <span class="n">SKIP_LIST_ALWAYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;__MACOSX&quot;</span><span class="p">,</span> <span class="s2">&quot;.DS_Store&quot;</span><span class="p">]</span>

    <span class="c1"># compute full skip list</span>
    <span class="c1"># note: we don&#39;t do</span>
    <span class="c1"># actual_skip_list = skip_list or SKIP_LIST_DEFAULT</span>
    <span class="c1"># because we want users to be able to pass in</span>
    <span class="c1"># skip_list=[] in order to clear the default skip list.</span>
    <span class="k">if</span> <span class="n">skip_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">actual_skip_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">SKIP_LIST_DEFAULT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">actual_skip_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">skip_list</span><span class="p">)</span>

    <span class="c1"># add the items we always want to skip</span>
    <span class="n">actual_skip_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">SKIP_LIST_ALWAYS</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">folder_permissions</span><span class="p">)</span>

    <span class="n">names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>

        <span class="c1"># get rid of system files</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">actual_skip_list</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">srcname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">dstname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">srcname</span><span class="p">):</span>
                <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">copy_folder</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span> <span class="n">dstname</span><span class="p">,</span> <span class="n">folder_permissions</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span> <span class="n">dstname</span><span class="p">)</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
                <span class="c1"># if the file extension is sh, set executable permissions</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">dstname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.sh&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">dstname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.bat&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">dstname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.exe&quot;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># make it readable and executable for everybody</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dstname</span><span class="p">,</span> <span class="mo">0o775</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Can&#39;t set executable permissions on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dstname</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t copy </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">srcname</span><span class="p">,</span> <span class="n">dstname</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">files</span></div>


<div class="viewcode-block" id="move_folder"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.move_folder">[docs]</a><span class="nd">@with_cleared_umask</span>
<span class="k">def</span><span class="w"> </span><span class="nf">move_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">folder_permissions</span><span class="o">=</span><span class="mo">0o775</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Moves a directory.</span>

<span class="sd">    First copies all content into target. Then deletes</span>
<span class="sd">    all content from sources. Skips files that won&#39;t delete.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The source folder itself is not deleted, it is just emptied, if possible.</span>

<span class="sd">    :param src: Source path to copy from</span>
<span class="sd">    :param dst: Destination to copy to</span>
<span class="sd">    :param folder_permissions: permissions to use for new folders</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Moving directory: </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span>

        <span class="c1"># first copy the content in the core folder</span>
        <span class="n">src_files</span> <span class="o">=</span> <span class="n">copy_folder</span><span class="p">(</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">folder_permissions</span><span class="p">,</span> <span class="n">skip_list</span><span class="o">=</span><span class="p">[]</span>  <span class="c1"># copy all files</span>
        <span class="p">)</span>

        <span class="c1"># now clear out the install location</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clearing out source location...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">src_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># on windows, ensure all files are writable</span>
                <span class="k">if</span> <span class="n">is_windows</span><span class="p">():</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span><span class="p">:</span>
                        <span class="c1"># file is readonly! - turn off this attribute</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not delete file </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="backup_folder"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.backup_folder">[docs]</a><span class="nd">@with_cleared_umask</span>
<span class="k">def</span><span class="w"> </span><span class="nf">backup_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Moves the given directory into a backup location.</span>

<span class="sd">    By default, the folder will be renamed by simply giving it a</span>
<span class="sd">    timestamp based suffix. Optionally, it can be moved into a different</span>
<span class="sd">    location.</span>

<span class="sd">    - ``backup_folder(&quot;/foo/bar&quot;)`` will move ``/foo/bar`` to ``/foo/bar.20160912_200426``</span>
<span class="sd">    - ``backup_folder(&quot;/foo/bar&quot;, &quot;/tmp&quot;)`` will move ``/foo/bar`` to ``/tmp/bar.20160912_200426``</span>

<span class="sd">    :param src: Folder to move</span>
<span class="sd">    :param dst: Optional backup folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backup_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backup_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">dst</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">timestamp</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">move_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_valid_filename"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.create_valid_filename">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">create_valid_filename</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a sanitized file name given a string.</span>
<span class="sd">    Replaces spaces and other characters with underscores</span>

<span class="sd">    &#39;my lovely name &#39; -&gt; &#39;my_lovely_name&#39;</span>

<span class="sd">    :param value: String value to sanitize</span>
<span class="sd">    :returns: sanitized string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># regex to find non-word characters - in ascii land, that is [^A-Za-z0-9_-.]</span>
    <span class="c1"># note that we use a unicode expression, meaning that it will include other</span>
    <span class="c1"># &quot;word&quot; characters, not just A-Z.</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\w\.-]&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

    <span class="c1"># strip trailing whitespace</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># src is unicode, so return unicode</span>
        <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># source is non-unicode.</span>
        <span class="c1"># assume utf-8 encoding so decode, replace</span>
        <span class="c1"># and re-encode the returned result</span>
        <span class="c1"># so that we return a string</span>
        <span class="n">u_src</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">u_src</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">get_permissions</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the file system permissions for the file or folder in the</span>
<span class="sd">    given path.</span>

<span class="sd">    :param filename: Path to the file to be queried for permissions</span>
<span class="sd">    :returns: permissions bits of the file</span>
<span class="sd">    :raises: OSError - if there was a problem retrieving permissions for the path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MODE</span><span class="p">])</span>


<div class="viewcode-block" id="safe_delete_folder"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.safe_delete_folder">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">safe_delete_folder</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes a folder and all of its contents recursively, even if it has read-only</span>
<span class="sd">    items.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Problems deleting any items will be reported as warnings in the log</span>
<span class="sd">        output but otherwise ignored and skipped; meaning the function will continue</span>
<span class="sd">        deleting as much as it can.</span>

<span class="sd">    :param path: File system path to location to the folder to be deleted</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_rm_error</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Error function called whenever shutil.rmtree fails to remove a file system</span>
<span class="sd">        item. Exceptions raised by this function will not be caught.</span>

<span class="sd">        :param func: The function which raised the exception; it will be:</span>
<span class="sd">                     os.path.islink(), os.listdir(), os.remove() or os.rmdir().</span>
<span class="sd">        :param path: The path name passed to function.</span>
<span class="sd">        :param exc_info: The exception information return by sys.exc_info().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span> <span class="ow">or</span> <span class="n">func</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span> <span class="ow">or</span> <span class="n">func</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">get_permissions</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span> <span class="o">|</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">func</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not delete </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">. Skipping&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not delete </span><span class="si">%s</span><span class="s2">: Skipping&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not delete </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">. Skipping&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not delete </span><span class="si">%s</span><span class="s2">. Skipping.&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># On Windows, Python&#39;s shutil can&#39;t delete read-only files, so if we were trying to delete one,</span>
            <span class="c1"># remove the flag.</span>
            <span class="c1"># Inspired by http://stackoverflow.com/a/4829285/1074536</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">_on_rm_error</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not delete </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not delete: </span><span class="si">%s</span><span class="s2">. Folder does not exist&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_unused_path"><a class="viewcode-back" href="../../../utils.html#sgtk.util.filesystem.get_unused_path">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">get_unused_path</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an unused file path from the given base path by appending if needed</span>
<span class="sd">    a number at the end of the basename of the path, right before the first &quot;.&quot;,</span>
<span class="sd">    if any.</span>

<span class="sd">    For example, ``/tmp/foo_1.bar.blah`` would be returned for ``/tmp/foo.bar.blah``</span>
<span class="sd">    if it already exists.</span>

<span class="sd">    If the given path does not exist, the original path is returned.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The returned path is not _reserved_, so it is possible that other processes</span>
<span class="sd">        could create the returned path before it is used by the caller.</span>

<span class="sd">    :param str base_path: Target path.</span>
<span class="sd">    :returns: A string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
        <span class="c1"># Bail out quickly if everything is fine with the path</span>
        <span class="k">return</span> <span class="n">base_path</span>

    <span class="c1"># Split the base path and find an unused path</span>
    <span class="n">folder</span><span class="p">,</span> <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
    <span class="c1"># Split the basename at the first &quot;.&quot;, if any. Make sure we always have at least</span>
    <span class="c1"># two entries.</span>
    <span class="n">base_parts</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">numbering</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">numbering</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">base_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">numbering</span><span class="p">,</span>
            <span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">base_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">base_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking if </span><span class="si">%s</span><span class="s2"> exists...&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">path</span></div>


<span class="nd">@with_cleared_umask</span>
<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">auto_created_yml</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A context manager for opening/closing an auto-generated yaml file.</span>

<span class="sd">    - clears umask</span>
<span class="sd">    - any existing files will be removed</span>
<span class="sd">    - the given path will be open for writing in text mode</span>
<span class="sd">    - a standard header will be added</span>

<span class="sd">    Usage example::</span>

<span class="sd">        with filesystem.auto_created_yml(yaml_path) as fh:</span>
<span class="sd">            fh.write(&quot;foobar: blah&quot;)</span>

<span class="sd">        # fh is automatically closed upon exiting the context</span>

<span class="sd">    :param path: path to yml file to open for writing</span>
<span class="sd">    :return: file handle.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating auto-generated config file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
    <span class="c1"># clean out any existing file and replace it with a new one.</span>

    <span class="n">safe_delete_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>

        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# This file was auto generated by SGTK.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;# Please do not modify by hand as it may be overwritten at any point.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;# Created </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># on entering the context</span>
        <span class="k">yield</span> <span class="n">fh</span>

        <span class="c1"># on exiting the context</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# End of file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">open_file_browser</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Opens the given path in the operating system file browser such as</span>
<span class="sd">    Windows explorer or Macosx Finder.</span>

<span class="sd">    If the path points at a file, the method will attempt to highlight</span>
<span class="sd">    the file.</span>

<span class="sd">    :param path: A path to a file or folder.</span>
<span class="sd">    :raises: RuntimeError: If the Platform is not supported or if</span>
<span class="sd">        the file browser couldn&#39;t be launched.</span>
<span class="sd">    :raises: ValueError: If the path is not a valid directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># open the file, attempt to select in finder/explorer</span>
        <span class="n">_open_file_browser_for_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># open the folder in finder/explorer</span>
        <span class="n">_open_file_browser_for_folder</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># possibly we have an image sequence and therefore its a symbolic path,</span>
        <span class="c1"># instead check to see if the parent folder of the path is valid and</span>
        <span class="c1"># try opening that.</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: The issue with this logic is that possibly it was a directory</span>
        <span class="c1"># that just didn&#39;t exist, so we would just be gathering the next</span>
        <span class="c1"># directory up.</span>
        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">_open_file_browser_for_folder</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_open_file_browser_for_folder</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method will take a path to a folder and open it in</span>
<span class="sd">    an OS&#39;s file browser.</span>

<span class="sd">    :param path: A folder path</span>
<span class="sd">    :raises: RuntimeError: If the Platform is not supported or if</span>
<span class="sd">        the file browser couldn&#39;t be launched.</span>
<span class="sd">    :raises: ValueError: If the path is not a valid directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Launching file system browser for folder </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># Check that we don&#39;t have a file path.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The path &quot;</span><span class="si">%s</span><span class="s1">&quot; is not a valid directory.&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># build the commands for opening the folder on the various OS&#39;s</span>
    <span class="k">if</span> <span class="n">is_linux</span><span class="p">():</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xdg-open&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">is_macos</span><span class="p">():</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">is_windows</span><span class="p">():</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cmd.exe&quot;</span><span class="p">,</span> <span class="s2">&quot;/C&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Platform &#39;</span><span class="si">%s</span><span class="s2">&#39; is not supported.&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing command &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">cmd_args</span><span class="p">)</span>
    <span class="n">exit_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Failed to launch a file browser for folder &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
            <span class="s2">&quot;Error code </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_open_file_browser_for_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method will take a path to a file and open it in</span>
<span class="sd">    an OS&#39;s file browser and attempt to highlight it.</span>

<span class="sd">    :param path: A file path</span>
<span class="sd">    :raises: RuntimeError: If the Platform is not supported or if</span>
<span class="sd">        the file browser couldn&#39;t be launched.</span>
<span class="sd">    :raises: ValueError: If the path is not a valid file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Launching file system browser for file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The path &quot;</span><span class="si">%s</span><span class="s1">&quot; is not a valid file path.&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_linux</span><span class="p">():</span>
        <span class="c1"># note: there isn&#39;t a straight forward way to do</span>
        <span class="c1"># this on linux, so just open the directory instead.</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xdg-open&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">is_macos</span><span class="p">():</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="s2">&quot;-R&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">is_windows</span><span class="p">():</span>
        <span class="c1"># /select makes windows select the file within the explorer window</span>
        <span class="c1"># The problem with this approach is that it always returns back an error code of 1 even if it</span>
        <span class="c1"># does behave correctly.</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;explorer&quot;</span><span class="p">,</span> <span class="s2">&quot;/select,&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Platform &#39;</span><span class="si">%s</span><span class="s2">&#39; is not supported.&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing command &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">cmd_args</span><span class="p">)</span>
    <span class="n">exit_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>

    <span class="c1"># cannot trust exit code from windows, see above</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_windows</span><span class="p">()</span> <span class="ow">and</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Failed to launch a file browser for file &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
            <span class="s2">&quot;Error code </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Autodesk.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 

  <script type="text/javascript">
    window.wafCCPAForceShow = true;
    (function(a,b,c,d){
      a='https://tags.tiqcdn.com/utag/autodesk/micro-basic/prod/utag.js';
      b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
      a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
    })();
  </script>


</body>
</html>